name: Gemini Automated Code Review

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - main

  workflow_dispatch:
    inputs:
      pr_number:
        description: "ë¦¬ë·°í•  PR ë²ˆí˜¸ (ê¸°ì¡´ PR ìˆ˜ë™ ë¦¬ë·° ì‹œ ì…ë ¥)"
        required: false

jobs:
  code_review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install GoogleGenerativeAI SDK
        run: npm install @google/generative-ai@latest

      - name: Determine PR Info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            let pr_number;

            if (context.eventName === "workflow_dispatch") {
              pr_number = context.payload.inputs["pr_number"];
              if (!pr_number) {
                core.setFailed("âŒ ìˆ˜ë™ ì‹¤í–‰ ì‹œì—ëŠ” PR ë²ˆí˜¸ ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return;
              }
            } else {
              pr_number = context.payload.pull_request.number;
            }

            console.log(`ğŸ” ë¦¬ë·°í•  PR ë²ˆí˜¸: ${pr_number}`);

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });

            console.log(`ğŸ“‚ base: ${pr.base.ref}, head: ${pr.head.ref}`);

            core.setOutput("number", pr_number);
            core.setOutput("base", pr.base.ref);
            core.setOutput("head", pr.head.ref);

      - name: Generate Git Diff for PR
        run: |
          git fetch origin "${{ github.event.pull_request.base.ref }}"
          git fetch origin "${{ github.event.pull_request.head.ref }}"
          git diff "origin/${{ github.event.pull_request.base.ref }}"..."origin/${{ github.event.pull_request.head.ref }}" > diff.txt

      - name: Run Gemini Review
        id: gemini_review
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const fs = require("fs");
            const { GoogleGenerativeAI } = require("@google/generative-ai");

            const diff_output = fs.readFileSync("diff.txt", "utf8");
            if (!diff_output.trim()) {
              console.log("No code changes detected, skipping review.");
              fs.writeFileSync("review_result.txt", "ë³€ê²½ëœ ì½”ë“œê°€ ì—†ì–´ ë¦¬ë·°ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.");
              return;
            }

            const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

            const chunkSize = 90000;
            const chunks = [];
            for (let i = 0; i < diff_output.length; i += chunkSize) {
              chunks.push(diff_output.slice(i, i + chunkSize));
            }

            let allReviews = [];
            console.log(`ğŸ“¦ ${chunks.length}ê°œì˜ ì²­í¬ë¡œ ë¶„í•  ì™„ë£Œ`);

            for (let i = 0; i < chunks.length; i++) {
              const partPrompt = `
              ë‹¹ì‹ ì€ **ì‹œë‹ˆì–´ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì**ì…ë‹ˆë‹¤.
              ì•„ë˜ëŠ” Pull Request diffì˜ ì¼ë¶€ì…ë‹ˆë‹¤ (íŒŒíŠ¸ ${i + 1}/${chunks.length}).

              ë³€ê²½ ë‚´ìš©ì„ ë©´ë°€íˆ ê²€í† í•˜ê³  ì•„ë˜ í•­ëª© ì¤‘ì‹¬ìœ¼ë¡œ ë¦¬ë·°í•˜ì„¸ìš”:
              1. ë²„ê·¸ ê°€ëŠ¥ì„±
              2. ì„±ëŠ¥ ë¬¸ì œ
              3. íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ ë¬¸ë²• / íƒ€ì… ê°œì„ ì 
              4. ë³€ìˆ˜ëª…, í•¨ìˆ˜ëª…, ì£¼ì„ í’ˆì§ˆ
              5. ì¤‘ë³µ ì½”ë“œ ë° ë¦¬íŒ©í† ë§ í¬ì¸íŠ¸
              6. êµ¬ì²´ì  ê°œì„  ì œì•ˆ (ìµœì†Œ 3ê°œ ì´ìƒ)

              <diff part ${i + 1}>
              ${chunks[i]}
              </diff>
              `;

              console.log(`ğŸ¤– Geminiì— part ${i + 1} ìš”ì²­ ì¤‘...`);
              const res = await model.generateContent(partPrompt);
              const text = res.response.text();
              allReviews.push(`### Part ${i + 1}\n${text}`);
            }

            const summaryPrompt = `
            ë‹¤ìŒì€ ì½”ë“œ ë¦¬ë·° íŒŒíŠ¸ë³„ ê²°ê³¼ì…ë‹ˆë‹¤.
            ì´ë¥¼ í†µí•©í•˜ì—¬ **í•˜ë‚˜ì˜ ì™„ì„±ëœ ë¦¬ë·°**ë¡œ ì •ë¦¬í•˜ì„¸ìš”.

            - ì¤‘ë³µ í”¼ë“œë°±ì€ ë³‘í•©
            - íŒŒì¼ë³„ë¡œ ì •ë¦¬
            - ëª…í™•í•˜ê³  ê°„ê²°í•˜ê²Œ ìœ ì§€

            ${allReviews.join("\n\n")}
            `;

            console.log("ğŸ§  Geminiì—ê²Œ ìµœì¢… ë¦¬ë·° ìš”ì•½ ìš”ì²­ ì¤‘...");
            const summaryRes = await model.generateContent(summaryPrompt);
            const finalText = summaryRes.response.text();

            fs.writeFileSync("review_result.txt", finalText);
            console.log("âœ… Gemini ë¦¬ë·° ê²°ê³¼ ì €ì¥ ì™„ë£Œ (ì „ì²´ diff í¬í•¨)");

      - name: Comment on Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const review = fs.readFileSync("review_result.txt", "utf8");

            const pr_number = ${{ steps.pr_info.outputs.number }};
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            console.log(`ğŸ—£ï¸ Gemini ì½”ë“œë¦¬ë·° ì—…ë°ì´íŠ¸ on PR #${pr_number}`);

            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number: pr_number
            });

            const existing = comments.find(c =>
              c.user?.type === "Bot" &&
              c.body?.startsWith("## ğŸ¤– Gemini ì½”ë“œë¦¬ë·° ê²°ê³¼")
            );

            if (existing) {
              console.log(`â™»ï¸ ê¸°ì¡´ Gemini ë¦¬ë·° ì½”ë©˜íŠ¸(#${existing.id}) ìˆ˜ì • ì¤‘...`);
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body: `## ğŸ¤– Gemini ì½”ë“œë¦¬ë·° ê²°ê³¼\n${review}`
              });
            } else {
              console.log("ğŸ’¬ ê¸°ì¡´ Gemini ë¦¬ë·° ì½”ë©˜íŠ¸ ì—†ìŒ â€” ìƒˆë¡œ ì‘ì„±");
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: pr_number,
                body: `## ğŸ¤– Gemini ì½”ë“œë¦¬ë·° ê²°ê³¼\n${review}`
              });
            }

            console.log("âœ… Gemini ë¦¬ë·° ì½”ë©˜íŠ¸ ê°±ì‹  ì™„ë£Œ");
