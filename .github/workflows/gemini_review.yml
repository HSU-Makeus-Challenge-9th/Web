name: Gemini Automated Code Review

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - main

  workflow_dispatch:
    inputs:
      pr_number:
        description: "Î¶¨Î∑∞Ìï† PR Î≤àÌò∏ (Í∏∞Ï°¥ PR ÏàòÎèô Î¶¨Î∑∞ Ïãú ÏûÖÎ†•)"
        required: false

jobs:
  code_review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install GoogleGenerativeAI SDK
        run: npm install @google/generative-ai@latest

      - name: Determine PR Info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            let pr_number;

            if (context.eventName === "workflow_dispatch") {
              pr_number = context.payload.inputs["pr_number"];
              if (!pr_number) {
                core.setFailed("‚ùå ÏàòÎèô Ïã§Ìñâ ÏãúÏóêÎäî PR Î≤àÌò∏ ÏûÖÎ†•Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
                return;
              }
            } else {
              pr_number = context.payload.pull_request.number;
            }

            console.log(`üîç Î¶¨Î∑∞Ìï† PR Î≤àÌò∏: ${pr_number}`);

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });

            console.log(`üìÇ base: ${pr.base.ref}, head: ${pr.head.ref}`);

            core.setOutput("number", pr_number);
            core.setOutput("base", pr.base.ref);
            core.setOutput("head", pr.head.ref);

      - name: Generate Git Diff for PR
        run: |
          echo "üìÇ base: ${{ steps.pr_info.outputs.base }}"
          echo "üìÇ head: ${{ steps.pr_info.outputs.head }}"
          git fetch origin "${{ steps.pr_info.outputs.base }}"
          git fetch origin "${{ steps.pr_info.outputs.head }}"
          git diff "origin/${{ steps.pr_info.outputs.base }}"..."origin/${{ steps.pr_info.outputs.head }}" > diff.txt

      - name: Run Gemini Review (Chunked)
        id: gemini_review
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const fs = require("fs");
            const diff_output = fs.readFileSync("diff.txt", "utf8");

            const { GoogleGenerativeAI } = require("@google/generative-ai");
            const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

            if (!diff_output.trim()) {
              fs.writeFileSync("review.json", "[]");
              return;
            }

            const CHUNK_SIZE = 30000;
            let chunks = [];
            for (let i = 0; i < diff_output.length; i += CHUNK_SIZE) {
              chunks.push(diff_output.slice(i, i + CHUNK_SIZE));
            }
            console.log(`üì¶ Ï≤≠ÌÅ¨ Í∞úÏàò: ${chunks.length}`);


            async function askGemini(prompt) {
              const res = await model.generateContent(prompt);
              return res.response.text();
            }

            let merged = [];

            for (let idx = 0; idx < chunks.length; idx++) {
              const chunk = chunks[idx];

              const prompt = `
              Explain in Korean.

              ÎãπÏã†ÏùÄ **ÏãúÎãàÏñ¥ ÌîÑÎ°†Ìä∏ÏóîÎìú Í∞úÎ∞úÏûê**ÏûÖÎãàÎã§.
              ÏïÑÎûò git diff Ï°∞Í∞Å(chunk ${idx+1}/${chunks.length})ÏùÑ Í∏∞Î∞òÏúºÎ°ú
              Î≥ÄÍ≤ΩÎêú ÏΩîÎìúÏùò 'Î≥ÄÍ≤ΩÎêú Ï§Ñ'ÎßàÎã§ Î¶¨Î∑∞ ÏΩîÎ©òÌä∏Î•º ÏÉùÏÑ±ÌïòÏÑ∏Ïöî.

              Ï∂úÎ†•ÏùÄ Î∞òÎìúÏãú **JSON Î∞∞Ïó¥Îßå**:

              [
                {
                  "path": "src/components/Example.tsx",
                  "line": 123,
                  "text": "Î¶¨Î∑∞ ÏΩîÎ©òÌä∏",
                  "side": "RIGHT"
                }
              ]

              Í∑úÏπô:
              - src ÎÇ¥Î∂ÄÏùò .ts / .tsx ÌååÏùºÎßå Î¶¨Î∑∞
              - ÏÑ±Îä• Î¨∏Ï†ú ÌåêÎã®
              - ÌÉÄÏûÖÏä§ÌÅ¨Î¶ΩÌä∏ Î¨∏Î≤ï/ÌÉÄÏûÖ Í∞úÏÑ† ÏßÄÏ†Å
              - Î≥ÄÏàòÎ™Ö/Ìï®ÏàòÎ™Ö/Ï£ºÏÑù ÌíàÏßà ÌèâÍ∞Ä
              - Ï§ëÎ≥µ ÏΩîÎìú/Î¶¨Ìå©ÌÜ†ÎßÅ Ìè¨Ïù∏Ìä∏ Ï†úÏïà
              - Í∞Å ÏΩîÎ©òÌä∏Îäî 1~2Ï§ÑÎßå ÏûëÏÑ±

              Îß§Ïö∞ Ï§ëÏöî:
              - "@@ -a,b +c,d @@" Î•º ÏÇ¨Ïö©Ìï¥ Ï†ïÌôïÌïú ÏÉà ÎùºÏù∏ Î≤àÌò∏ Í≥ÑÏÇ∞
              - JSON ÏΩîÎìúÎ∏îÎ°ù Í∏àÏßÄ (```json Ìè¨Ìï® Í∏àÏßÄ)
              - JSON Ïô∏ Îã§Î•∏ ÌÖçÏä§Ìä∏Î•º Ï†àÎåÄ Ï∂úÎ†•ÌïòÏßÄ Îßê Í≤É

              <git diff>
              ${chunk}
              </git diff>
              `;

              console.log(`ü§ñ Gemini ÏöîÏ≤≠: chunk ${idx+1}/${chunks.length}`);
              let raw = await askGemini(prompt);

              // ÏΩîÎìúÎ∏îÎ°ù Ï†úÍ±∞
              raw = raw.replace(/```json/g, "").replace(/```/g, "").trim();

              try {
                const parsed = JSON.parse(raw);
                merged.push(...parsed);
              } catch (e) {
                console.log("‚ùå JSON ÌååÏã± Ïã§Ìå®. Ï∂úÎ†•:");
                console.log(raw);
                throw e;
              }
            }

            fs.writeFileSync("review.json", JSON.stringify(merged, null, 2));
            console.log("üéâ Î™®Îì† Ï≤≠ÌÅ¨ JSON Î≥ëÌï© ÏôÑÎ£å");

      - name: Convert JSON to diff positions
        id: convert
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            let raw = fs.readFileSync("review.json", "utf8")
            raw = raw
              .replace(/```json/g, "")
              .replace(/```/g, "")
              .trim();

            const jsonMatch = raw.match(/\[[\s\S]*\]/);

            if (!jsonMatch) {
              console.log("‚ùå JSON Î∞∞Ïó¥ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå!");
              console.log("Raw output:");
              console.log(raw);
              throw new Error("Gemini JSON extraction failed");
            }

            let jsonString = jsonMatch[0];

            let review;
            try {
              review = JSON.parse(jsonString);
            } catch (e) {
              console.log("‚ùå JSON.parse Ïã§Ìå®");
              console.log("ÏõêÎ≥∏ JSON Î¨∏ÏûêÏó¥:");
              console.log(jsonString);
              throw e;
            }
            const diff = fs.readFileSync("diff.txt", "utf8");

            const output = [];
            const fileBlocks = diff.split("diff --git").slice(1);

            for (const block of fileBlocks) {
              const pathMatch = block.match(/b\/(.+)\nindex/);
              if (!pathMatch) continue;

              const path = pathMatch[1];
              const fileComments = review.filter(c => c.path === path);
              if (fileComments.length === 0) continue;

              const lines = block.split("\n");
              let position = 0;
              let newLine = 0;
              let oldLine = 0;

              for (const line of lines) {
                position++;

                if (line.startsWith("@@")) {
                  const m = line.match(/@@ -(\d+),?\d* \+(\d+),?\d* @@/);
                  if (m) {
                    oldLine = parseInt(m[1]);
                    newLine = parseInt(m[2]);
                  }
                  continue;
                }

                if (line.startsWith("+")) {
                  newLine++;
                  const match = fileComments.find(c => c.line === newLine);
                  if (match) {
                    output.push({
                      path,
                      position,
                      body: match.text
                    });
                  }
                  continue;
                }

                if (line.startsWith("-")) {
                  oldLine++;
                  continue;
                }

                oldLine++; newLine++;
              }
            }

            core.setOutput("comments", JSON.stringify(output));

      - name: Submit Code Review
        uses: actions/github-script@v7
        with:
          script: |
            const comments = JSON.parse(`${{ steps.convert.outputs.comments }}`);

            if (!comments.length) {
              console.log("ÏΩîÎ©òÌä∏ ÏóÜÏùå ‚Äî Î¶¨Î∑∞ ÏÉùÎûµ");
              return;
            }

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr_info.outputs.number }},
              event: "COMMENT",
              comments
            });

            console.log("ÎùºÏù∏Î≥Ñ ÏΩîÎìú Î¶¨Î∑∞ Ï†úÏ∂ú ÏôÑÎ£å!");
