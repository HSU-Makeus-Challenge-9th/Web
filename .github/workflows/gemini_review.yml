name: Gemini Automated Code Review

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - main

jobs:
  code_review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install GoogleGenerativeAI SDK
        run: npm install @google/generative-ai@latest

      - name: Generate Git Diff for PR
        run: |
          git fetch origin "${{ github.event.pull_request.base.ref }}"
          git fetch origin "${{ github.event.pull_request.head.ref }}"
          git diff "origin/${{ github.event.pull_request.base.ref }}"..."origin/${{ github.event.pull_request.head.ref }}" > diff.txt

      - name: Run Gemini Review
        id: gemini_review
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const fs = require("fs");
            const diff_output = fs.readFileSync("diff.txt", "utf8");

            if (!diff_output.trim()) {
              console.log("No code changes detected, skipping review.");
              fs.writeFileSync("review_result.txt", "ë³€ê²½ëœ ì½”ë“œê°€ ì—†ì–´ ë¦¬ë·°ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.");
              return;
            }

            const { GoogleGenerativeAI } = require("@google/generative-ai");
            const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY, { apiVersion: "v1" });
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-pro" });

            const prompt = `
            ë‹¹ì‹ ì€ **ì‹œë‹ˆì–´ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì**ì…ë‹ˆë‹¤.

            ë‹¤ìŒì€ Pull Requestì˜ git diff ë‚´ìš©ì…ë‹ˆë‹¤.
            ê° íŒŒì¼ì˜ ë³€ê²½ì‚¬í•­ì„ ë©´ë°€íˆ ê²€í† í•˜ê³  ì•„ë˜ í•­ëª© ì¤‘ì‹¬ìœ¼ë¡œ ë¦¬ë·°ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

            1. ì ì¬ì ì¸ ë²„ê·¸ë‚˜ ë¡œì§ ì˜¤ë¥˜
            2. ì„±ëŠ¥ ì €í•˜ë¥¼ ìœ ë°œí•  ìˆ˜ ìˆëŠ” ë¶€ë¶„
            3. íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ ë¬¸ë²• / íƒ€ì… ì˜¤ë¥˜ ë° ê°œì„ ì 
            4. ë³€ìˆ˜ëª…, í•¨ìˆ˜ëª…, ì£¼ì„ ìŠ¤íƒ€ì¼ ê´€ë ¨ ê°œì„ ì 
            5. ì¤‘ë³µ ì½”ë“œ, í•˜ë“œì½”ë”©ëœ ê°’, ë¦¬íŒ©í† ë§ í¬ì¸íŠ¸
            6. ì „ë°˜ì ì¸ ì½”ë“œ í’ˆì§ˆ ë° ê°€ë…ì„±
            7. êµ¬ì²´ì ì´ê³  ê±´ì„¤ì ì¸ ê°œì„  ì œì•ˆ (ìµœì†Œ 5ê°œ ì´ìƒ)

            **ì¶œë ¥ í˜•ì‹ ìš”êµ¬ì‚¬í•­**
            - í•œêµ­ì–´ë¡œ ì‘ì„±
            - íŒŒì¼ë³„ ì„¹ì…˜ êµ¬ë¶„ (ì˜ˆ: ### src/components/Button.tsx)
            - ë§ˆí¬ë‹¤ìš´ í˜•ì‹ ì‚¬ìš©
            - ë¶ˆí•„ìš”í•œ ì„œë¡ /ê²°ë¡  ì—†ì´ ë¦¬ë·° ë‚´ìš©ë§Œ ì¶œë ¥

            ì•„ë˜ëŠ” ë³€ê²½ëœ ì½”ë“œì…ë‹ˆë‹¤:

            <git diff>
            ${diff_output}
            </git diff>
            `;

            console.log("ğŸ¤– Geminiì—ê²Œ ì½”ë“œ ë¦¬ë·° ìš”ì²­ ì¤‘...");

            const result = await model.generateContent(prompt);
            const text = await result.response.text();

            fs.writeFileSync("review_result.txt", text);
            console.log("âœ… Gemini ë¦¬ë·° ê²°ê³¼ ì €ì¥ ì™„ë£Œ");

      - name: Comment on Pull Request
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const review = fs.readFileSync("review_result.txt", "utf8");

            const pr_number = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            console.log(`ğŸ—£ï¸ Posting Gemini review to PR #${pr_number}`);

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: `## ğŸ¤– Gemini ì½”ë“œë¦¬ë·° ê²°ê³¼\n${review}`
            });

            console.log("âœ… Gemini ë¦¬ë·° ì½”ë©˜íŠ¸ ì‘ì„± ì™„ë£Œ");
