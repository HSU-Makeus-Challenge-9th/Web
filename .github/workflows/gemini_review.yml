name: Gemini Automated Code Review

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - main

  workflow_dispatch:
    inputs:
      pr_number:
        description: "Î¶¨Î∑∞Ìï† PR Î≤àÌò∏ (Í∏∞Ï°¥ PR ÏàòÎèô Î¶¨Î∑∞ Ïãú ÏûÖÎ†•)"
        required: false

jobs:
  code_review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install GoogleGenerativeAI SDK
        run: npm install @google/generative-ai@latest

      - name: Determine PR Info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            let pr_number;

            if (context.eventName === "workflow_dispatch") {
              pr_number = context.payload.inputs["pr_number"];
              if (!pr_number) {
                core.setFailed("‚ùå ÏàòÎèô Ïã§Ìñâ ÏãúÏóêÎäî PR Î≤àÌò∏ ÏûÖÎ†•Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
                return;
              }
            } else {
              pr_number = context.payload.pull_request.number;
            }

            console.log(`üîç Î¶¨Î∑∞Ìï† PR Î≤àÌò∏: ${pr_number}`);

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });

            console.log(`üìÇ base: ${pr.base.ref}, head: ${pr.head.ref}`);

            core.setOutput("number", pr_number);
            core.setOutput("base", pr.base.ref);
            core.setOutput("head", pr.head.ref);

      - name: Generate Git Diff for PR
        run: |
          echo "üìÇ base: ${{ steps.pr_info.outputs.base }}"
          echo "üìÇ head: ${{ steps.pr_info.outputs.head }}"
          git fetch origin "${{ steps.pr_info.outputs.base }}"
          git fetch origin "${{ steps.pr_info.outputs.head }}"
          git diff "origin/${{ steps.pr_info.outputs.base }}"..."origin/${{ steps.pr_info.outputs.head }}" > diff.txt

      - name: Run Gemini Review with Chunking
        id: gemini_review
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const fs = require("fs");

            const diff_output = fs.readFileSync("diff.txt", "utf8");
            if (!diff_output.trim()) {
              console.log("No code changes detected, skipping review.");
              fs.writeFileSync("review.json", "[]");
              return;
            }

            const { GoogleGenerativeAI } = require("@google/generative-ai");
            const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

            const CHUNK_SIZE = 90000;
            const chunks = [];

            for (let i = 0; i < diff_output.length; i += CHUNK_SIZE) {
              chunks.push(diff_output.substring(i, i + CHUNK_SIZE));
            }

            console.log(`üì¶ Ï¥ù ${chunks.length}Í∞úÏùò Ï≤≠ÌÅ¨Î°ú Î∂ÑÌï†Îê®`);

            const finalReviews = [];

            for (let idx = 0; idx < chunks.length; idx++) {
              const chunk = chunks[idx];

              console.log(`‚ñ∂ Gemini ÏöîÏ≤≠ Ï§ë... Ï≤≠ÌÅ¨ ${idx + 1}/${chunks.length}`);

              const prompt = `
              Explain in Korean.

              ÎãπÏã†ÏùÄ **ÏãúÎãàÏñ¥ ÌîÑÎ°†Ìä∏ÏóîÎìú Í∞úÎ∞úÏûê**ÏûÖÎãàÎã§.
              ÏïÑÎûò git diffÎßåÏùÑ Í∏∞Î∞òÏúºÎ°ú Î≥ÄÍ≤ΩÎêú Ï§ÑÏóê ÎåÄÌïú ÏΩîÎìú Î¶¨Î∑∞ ÏΩîÎ©òÌä∏Î•º JSON Î∞∞Ïó¥Î°ú ÏûëÏÑ±ÌïòÏÑ∏Ïöî.

              Î∞òÎìúÏãú ÏïÑÎûò ÌòïÏãùÏúºÎ°úÎßå Ï∂úÎ†•ÌïòÏÑ∏Ïöî:

              [
                {
                  "path": "src/components/Example.tsx",
                  "line": 123,
                  "text": "ÏΩîÎ©òÌä∏",
                  "side": "RIGHT"
                }
              ]

              Í∑úÏπô:
              1. src ÎÇ¥Î∂Ä .ts / .tsx ÌååÏùºÎßå Ìè¨Ìï®
              2. Ï≤≠ÌÅ¨Ïóê ÏóÜÎäî ÌååÏùº/ÎùºÏù∏ Ï†ïÎ≥¥Îäî Ï†àÎåÄ ÏûëÏÑ± Í∏àÏßÄ
              3. JSON Ïù¥Ïô∏Ïùò ÏÑ§Î™Ö ÌÖçÏä§Ìä∏ Ï†àÎåÄ Í∏àÏßÄ

              <git diff chunk>
              ${chunk}
              </git diff chunk>
              `;

              try {
                const result = await model.generateContent(prompt);
                let text = result.response.text().trim();
                
                text = text.replace(/```json|```/g, "").trim();

                let parsed = [];
                try {
                  parsed = JSON.parse(text);
                  if (!Array.isArray(parsed)) parsed = [];
                } catch (err) {
                  console.log("‚ö† JSON parse Ïã§Ìå® ‚Üí Ìï¥Îãπ Ï≤≠ÌÅ¨Îäî Í±¥ÎÑàÎúÄ");
                  continue;
                }

                finalReviews.push(...parsed);

              } catch (error) {
                console.log("‚ùå Gemini ÏöîÏ≤≠ Ïã§Ìå®:", error.message);
              }
            }

            fs.writeFileSync("review.json", JSON.stringify(finalReviews, null, 2));
            console.log("üéâ Î™®Îì† Ï≤≠ÌÅ¨ Ï≤òÎ¶¨ ÏôÑÎ£å ‚Üí review.json ÏÉùÏÑ±Îê®");

      - name: Convert JSON to diff positions
        id: convert
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            let raw = fs.readFileSync("review.json", "utf8")
              .trim()
              .replace(/```json/g, "")
              .replace(/```/g, "")
              .replace(/^\n+|\n+$/g, "");

            let review;

            try {
              review = JSON.parse(raw);
            } catch (err) {
              console.log("Gemini JSON parse error");
              console.log("Raw output:");
              console.log(raw);
              throw err;
            }

            const diff = fs.readFileSync("diff.txt", "utf8");

            const output = [];

            const fileBlocks = diff.split("diff --git").slice(1);

            for (const block of fileBlocks) {
              const pathMatch = block.match(/b\/(.+)\nindex/);
              if (!pathMatch) continue;

              const path = pathMatch[1];
              const fileComments = review.filter(c => c.path === path);
              if (fileComments.length === 0) continue;

              const lines = block.split("\n");
              let position = 0;
              let newLine = 0;
              let oldLine = 0;

              for (const line of lines) {
                position++;

                if (line.startsWith("@@")) {
                  const m = line.match(/@@ -(\d+),?\d* \+(\d+),?\d* @@/);
                  if (m) {
                    oldLine = parseInt(m[1]);
                    newLine = parseInt(m[2]);
                  }
                  continue;
                }

                if (line.startsWith("+")) {
                  newLine++;
                  const comment = fileComments.find(c => c.line === newLine);
                  if (comment) {
                    output.push({
                      path,
                      position,
                      body: comment.text
                    });
                  }
                  continue;
                }

                if (line.startsWith("-")) {
                  oldLine++;
                  continue;
                }

                oldLine++;
                newLine++;
              }
            }

            core.setOutput("comments", JSON.stringify(output));

      - name: Submit Code Review
        uses: actions/github-script@v7
        with:
          script: |
            const comments = JSON.parse(`${{ steps.convert.outputs.comments }}`);

            if (!comments.length) {
              console.log("No review comments generated.");
              return;
            }

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr_info.outputs.number }},
              event: "COMMENT",
              comments
            });

            console.log("ÎùºÏù∏Î≥Ñ ÏΩîÎìú Î¶¨Î∑∞ Ï†úÏ∂úÎê®!");
