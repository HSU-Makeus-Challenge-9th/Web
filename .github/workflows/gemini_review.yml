name: Gemini Automated Code Review

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - main

  workflow_dispatch:
    inputs:
      pr_number:
        description: "ë¦¬ë·°í•  PR ë²ˆí˜¸ (ê¸°ì¡´ PR ìˆ˜ë™ ë¦¬ë·° ì‹œ ì…ë ¥)"
        required: false

jobs:
  code_review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install GoogleGenerativeAI SDK
        run: npm install @google/generative-ai@latest

      - name: Determine PR Info
        id: pr_info
        uses: actions/github-script@v7
        with:
          script: |
            let pr_number;

            if (context.eventName === "workflow_dispatch") {
              pr_number = context.payload.inputs["pr_number"];
              if (!pr_number) {
                core.setFailed("âŒ ìˆ˜ë™ ì‹¤í–‰ ì‹œì—ëŠ” PR ë²ˆí˜¸ ì…ë ¥ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return;
              }
            } else {
              pr_number = context.payload.pull_request.number;
            }

            console.log(`ğŸ” ë¦¬ë·°í•  PR ë²ˆí˜¸: ${pr_number}`);

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr_number
            });

            console.log(`ğŸ“‚ base: ${pr.base.ref}, head: ${pr.head.ref}`);

            core.setOutput("number", pr_number);
            core.setOutput("base", pr.base.ref);
            core.setOutput("head", pr.head.ref);

      - name: Generate Git Diff for PR
        run: |
          echo "ğŸ“‚ PR Base: ${{ steps.pr_info.outputs.base }}"
          echo "ğŸ“‚ PR Head: ${{ steps.pr_info.outputs.head }}"

          git fetch origin "refs/pull/${{ steps.pr_info.outputs.number }}/head":pr-head
          git fetch origin "refs/pull/${{ steps.pr_info.outputs.number }}/base":pr-base

          git diff pr-base pr-head > diff.txt

      - name: Run Gemini Review (Line-by-Line JSON)
        id: gemini_review
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        with:
          script: |
            const fs = require("fs");
            const diff_output = fs.readFileSync("diff.txt", "utf8");

            const { GoogleGenerativeAI } = require("@google/generative-ai");

            if (!diff_output.trim()) {
              console.log("No code changes detected, skipping review.");
              fs.writeFileSync("review_result.txt", "ë³€ê²½ëœ ì½”ë“œê°€ ì—†ì–´ ë¦¬ë·°ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.");
              return;
            }

            const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash" });

            const prompt = `
            Explain in Korean.

            ë‹¹ì‹ ì€ **ì‹œë‹ˆì–´ í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì**ì…ë‹ˆë‹¤.
            ì•„ë˜ git diffë¥¼ ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½ëœ ì¤„ë§ˆë‹¤ ì½”ë“œë¦¬ë·° ì½”ë©˜íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

            ë°˜ë“œì‹œ ë‹¤ìŒ JSON í˜•ì‹ì„ **ì—„ê²©íˆ** ì§€ì¼œì„œ ì¶œë ¥í•˜ì‹­ì‹œì˜¤:

            [
              {
                "path": "src/components/Example.tsx",
                "line": 123,
                "text": "ë¼ì¸ë³„ ë¦¬ë·° ì½”ë©˜íŠ¸",
                "side": "RIGHT"
              }
            ]

            ê·œì¹™:
            1. **ë¬´ì¡°ê±´ src ë‚´ë¶€ì— ìˆëŠ” .ts ë° .tsx íŒŒì¼ë§Œ ë¦¬ë·°í•©ë‹ˆë‹¤.**
            2. **ì„±ëŠ¥ ë¬¸ì œ**ê°€ ìˆëŠ”ì§€ í•´ë‹¹ ë¼ì¸ ê¸°ì¤€ìœ¼ë¡œ í‰ê°€í•©ë‹ˆë‹¤.
            3. **íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ ë¬¸ë²• ì˜¤ë¥˜, íƒ€ì… ë¯¸ìŠ¤ë§¤ì¹˜, íƒ€ì… ê°œì„  í¬ì¸íŠ¸**ê°€ ìˆìœ¼ë©´ ì§€ì í•©ë‹ˆë‹¤.
            4. **ë³€ìˆ˜ëª…, í•¨ìˆ˜ëª…, ì£¼ì„ í’ˆì§ˆ**ì´ ë¶€ì¡±í•œ ê²½ìš° ê°œì„  ì˜ê²¬ì„ ëƒ…ë‹ˆë‹¤.
            5. **ì¤‘ë³µ ì½”ë“œ ë˜ëŠ” ë¦¬íŒ©í† ë§ í¬ì¸íŠ¸**ê°€ ë³´ì´ë©´ ê°„ë‹¨í•˜ê²Œ ì œì•ˆí•©ë‹ˆë‹¤.
            6. ë‹¨, ë¼ì¸ë³„ ë¦¬ë·° íŠ¹ì„±ìƒ **ê° ì½”ë©˜íŠ¸ëŠ” 1~2ì¤„ë¡œ ê°„ê²°í•˜ê²Œ ì‘ì„±**í•©ë‹ˆë‹¤.
              (ì „ì²´ íŒŒì¼ ê¸°ì¤€ 5~8ê°œ ì œì•ˆì€ ë¶ˆê°€ëŠ¥í•˜ë¯€ë¡œ "í•´ë‹¹ ì¤„ì— í•„ìš”í•œ ì œì•ˆ"ë§Œ ì‘ì„±)

            ë§¤ìš° ì¤‘ìš”:
            - diff ì˜ "@@ -a,b +c,d @@" ì •ë³´ë¥¼ ì´ìš©í•´ **ì •í™•í•œ ì‹¤ì œ ë³€ê²½ ë¼ì¸ ë²ˆí˜¸(line)** ë¥¼ ê³„ì‚°í•´ì•¼ í•©ë‹ˆë‹¤.
            - JSON í˜•ì‹ì´ ì¡°ê¸ˆì´ë¼ë„ ê¹¨ì§€ë©´ ì•ˆ ë©ë‹ˆë‹¤.
            - JSON ì´ì™¸ì˜ ì„¤ëª… í…ìŠ¤íŠ¸ë¥¼ ì ˆëŒ€ ì¶œë ¥í•˜ì§€ ë§ˆì„¸ìš”.

            <git diff>
            ${diff_output}
            </git diff>
            `;

            const result = await model.generateContent(prompt);
            const text = result.response.text();

            fs.writeFileSync("review.json", text);

      - name: Convert JSON to diff positions
        id: convert
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const review = JSON.parse(fs.readFileSync("review.json", "utf8"));
            const diff = fs.readFileSync("diff.txt", "utf8");

            const output = [];

            const fileBlocks = diff.split("diff --git").slice(1);

            for (const block of fileBlocks) {
              const pathMatch = block.match(/b\/(.+)\nindex/);
              if (!pathMatch) continue;

              const path = pathMatch[1];
              const fileComments = review.filter(c => c.path === path);
              if (fileComments.length === 0) continue;

              const lines = block.split("\n");
              let position = 0;
              let newLine = 0;
              let oldLine = 0;

              for (const line of lines) {
                position++;

                if (line.startsWith("@@")) {
                  const m = line.match(/@@ -(\d+),?\d* \+(\d+),?\d* @@/);
                  if (m) {
                    oldLine = parseInt(m[1]);
                    newLine = parseInt(m[2]);
                  }
                  continue;
                }

                if (line.startsWith("+")) {
                  newLine++;
                  const comment = fileComments.find(c => c.line === newLine);
                  if (comment) {
                    output.push({
                      path,
                      position,
                      body: comment.text
                    });
                  }
                  continue;
                }

                if (line.startsWith("-")) {
                  oldLine++;
                  continue;
                }

                oldLine++;
                newLine++;
              }
            }

            core.setOutput("comments", JSON.stringify(output));

      - name: Submit Code Review
        uses: actions/github-script@v7
        with:
          script: |
            const comments = JSON.parse(`${{ steps.convert.outputs.comments }}`);

            if (!comments.length) {
              console.log("No review comments generated.");
              return;
            }

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.pr_info.outputs.number }},
              event: "COMMENT",
              comments
            });

            console.log("ë¼ì¸ë³„ ì½”ë“œ ë¦¬ë·° ì œì¶œë¨!");
